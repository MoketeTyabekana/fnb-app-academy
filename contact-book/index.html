<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
    />
  </head>
  <body onload="fetchContacts()">
    <nav>
      <div class="logo">
        <span class="material-symbols-outlined">contacts</span>
        <h1>Contact Book</h1>
      </div>

      <div class="buttons">
        <span
          class="material-symbols-outlined"
          onclick="fetchContacts()"
          style="cursor: pointer"
          >refresh</span
        >
        <span
          class="material-symbols-outlined"
          onclick="addContact()"
          style="cursor: pointer"
          >person_add</span
        >
      </div>
    </nav>

    <section>
      <input type="search" id="search" placeholder="Search Contacts" onclick="search()"/>
      <div id="table">
        <p id="loading-text">Contacts Loading...</p>
      </div>
    </section>

    <script src="config.js"></script>
    <script>
      function fetchContacts() {
        fetch(rootPath + "controller/get-contacts/")
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            displayOutput(data);
          });
      }

      function displayOutput(contactArray) {
        contactArray.sort(function (a, b) {
          const nameA = (a.firstname + " " + a.lastname).toLowerCase();
          const nameB = (b.firstname + " " + b.lastname).toLowerCase();
          if (nameA < nameB) return -1;
          if (nameA > nameB) return 1;
          return 0;
        });

        let output = "<table class='table'>";

        
        const nameRegex = /^[A-Za-z]+$/;

        for (let a in contactArray) {
          const first = contactArray[a].firstname ? contactArray[a].firstname.trim() : "";
          const last = contactArray[a].lastname ? contactArray[a].lastname.trim() : "";

          
          if (
            first &&
            last &&
            nameRegex.test(first) &&
            nameRegex.test(last)
          ) {
            output += `
              <tr onclick="editContact(${contactArray[a].id})">
                <td><img src="${rootPath}controller/uploads/${contactArray[a].avatar}" width="40" height="40"/></td>
                <td><h4>${first}</h4></td>
                <td><h4>${last}</h4></td>
              </tr>
            `;
          }
        }

        output += "</table>";
        document.getElementById("table").innerHTML = output;
      }

      function editContact(id) {
        window.open("edit-contact.html?id=" + id, "_self");
      }

      function addContact() {
        window.open("insert-contact.html?", "_self");
      }

      function search() {
        const searchValue = document.getElementById("search").value.toLowerCase();
        const rows = document.querySelectorAll(".table tr");

        rows.forEach((row) => {
          const name = row.querySelector("td:nth-child(2) h4").textContent.toLowerCase();
          if (name.includes(searchValue)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }
    </script>
  </body>
</html>
